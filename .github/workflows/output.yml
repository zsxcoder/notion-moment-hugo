name: fetch content from Notion & deploy to Vercel

on:
  workflow_dispatch:
  push:

env:
  NOTION_SECRET:      ${{ secrets.NOTION_SECRET }}
  NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
  HUGO_VERSION:       0.139.0

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    steps:
      # ---------- 1. 一次性把源码、Python、Node 依赖全准备好 ----------
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - run: pip install notion-client==2.2.1

      # ---------- 2. 拉取解析器与主题 ----------
      - name: Pull parser & theme
        run: |
          git clone --depth 1 https://github.com/zsxcoder/notion-moments-database-parser.git scripts
          git clone --depth 1 https://github.com/zsxcoder/notion-hugo-moments.git themes/moments

      # ---------- 3. 生成 markdown ----------
      - run: python scripts/main.py

      # ---------- 4. 官方 Hugo Action（自带缓存、Sass、Extended） ----------
      - uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      # ---------- 5. 构建 ----------
      - run: hugo --gc --minify --baseURL ${{ secrets.VERCEL_PROJECT_URL }}

      # ---------- 6. 部署 ----------
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token:      ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id:     ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./public
          vercel-args:       '--prod'
